shell å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œåº”è¯¥æ˜¯ä¸ªç†Ÿæ‚‰å¾—ä¸èƒ½å†ç†Ÿæ‚‰çš„è€æœ‹å‹äº†ï¼Œå‡ ä¹å¤©å¤©éƒ½ä¼šæ¥è§¦ã€‚å½“æˆ‘ä»¬å™¼é‡Œå•ªå•¦æ•²ä¸€å †å‘½ä»¤åï¼Œå®ƒä¼šå¸®æˆ‘ä»¬æ‰§è¡Œï¼Œç„¶åæ˜¾ç¤ºç»“æœã€‚

é‚£ä¹ˆ shell ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ

ç®€å•æ¥è¯´ï¼Œshell æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œæ¥å£ï¼Œæ˜¯ä¸€ä¸ªç¨‹åºï¼Œæ˜¯ç”¨æˆ·ä¸æ“ä½œç³»ç»Ÿå†…æ ¸äº¤äº’çš„æ¡¥æ¢ã€‚å®ƒçš„ä¸»ä½“åŠŸèƒ½åŒ…æ‹¬ï¼š

- ç­‰å¾…è¯»å–å‘½ä»¤
- è§£æå‘½ä»¤
- æ‰§è¡Œå‘½ä»¤

ä»ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“è§‚å¯Ÿåˆ°çš„ä¸€ä¸ªç°è±¡æ˜¯ï¼šå½“è¾“å…¥ä¸€ä¸ªå‘½ä»¤ï¼Œå›è½¦æ‰§è¡Œåï¼Œç¨‹åºå¹¶æ²¡æœ‰é€€å‡ºï¼Œè€Œæ˜¯æ¥ç€ç­‰å¾…ç»§ç»­è¾“å…¥ã€‚

![](https://cdn.jsdelivr.net/gh/silan-liu/picRepo/img20210304090231.jpg)

æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæƒ³ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸æ–­å¾ªç¯çš„è¿‡ç¨‹ã€‚å†…éƒ¨å®ç°ä¸€å®šæœ‰ä¸ªå¾ªç¯ï¼Œé‡å¤çš„åœ¨åšä¸Šé¢æ‰€è¿°çš„ 3 ä¸ªæ­¥éª¤ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å…·ä½“å®æˆ˜ä¸‹ï¼Œå¦‚ä½•ç”¨ c æ¥ç¼–å†™ä¸€ä¸ªç®€å•çš„ shellã€‚è¯·æ”¾å¿ƒé˜…è¯»ï¼Œå› ä¸ºçœŸçš„å¾ˆç®€å•ğŸ˜ƒã€‚

## æ•ˆæœé¢„è§ˆ

é¦–å…ˆæ¥çœ‹ä¸‹æ•ˆæœï¼Œä»¥ `$ silan >` å¼€å¤´çš„å°±æ˜¯æˆ‘ä»¬ç¼–å†™çš„ shellã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://cdn.jsdelivr.net/gh/silan-liu/picRepo/img20210306093709.png)

## å¾ªç¯ä½“

æ•´ä¸ªå¾ªç¯åŒ…æ‹¬è¯»å–ã€è§£æã€æ‰§è¡Œï¼Œæ˜¯å¦é€€å‡ºå¾ªç¯æ ¹æ®å‘½ä»¤æ‰§è¡Œçš„è¿”å›å€¼æ¥ç¡®å®šã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://cdn.jsdelivr.net/gh/silan-liu/picRepo/img20210305213929.png)

ä¸‹é¢ä»£ç å°±æ˜¯å¾ªç¯çš„æ¡†æ¶ã€‚æˆ‘ä»¬å…ˆå°†å…¶å®ç°ç©ºå‡ºæ¥ï¼Œåœ¨åé¢å¡«å…¥ã€‚

```objectivec
void lsh_loop()
{
  int status;

  do
  {
    printf("\n$ silan > ");

    // è¯»å–

    // è§£æ

    // æ‰§è¡Œï¼Œè¿”å› status

  } while (status);
}
```

åœ¨æ¯ä¸ªå¾ªç¯ä¸­ï¼Œéƒ½ä¼šé¢„å…ˆæ‰“å° `$ silan >` ä¸€ä¸²æç¤ºç¬¦ï¼Œçœ‹èµ·æ¥è·Ÿæˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„ shell æ˜¯ä¸æ˜¯å¾ˆç±»ä¼¼ğŸ˜†ã€‚

å¦å¤–ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰æ·»åŠ æç¤ºå…ƒç´ ï¼Œæ¯”å¦‚æ˜¾ç¤ºå½“å‰æ—¶é—´ã€‚

## è¯»å–å‘½ä»¤

è¿™ä¸€æ­¥ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥å‘½ä»¤ï¼Œä»¥ç©ºæ ¼ç¬¦åˆ†å‰²ã€‚å½“é”®å…¥å›è½¦æˆ–è€… `CTRL+D` æ—¶ï¼Œä»£è¡¨è¾“å…¥å®Œæˆã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ `getline` æ¥è·å–è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨ `feof` åˆ¤æ–­æ˜¯å¦ä¸ºç»“æŸç¬¦ã€‚

```objectivec
// è¯»å–å‘½ä»¤
char *lsh_read_cmd()
{
  char *cmd = NULL;
  size_t buffSize = 0;

  if (getline(&cmd, &buffSize, stdin) == -1)
  {
    // eof ç»“æŸç¬¦
    // ctrl+d/å›è½¦
    if (feof(stdin))
    {
      exit(EXIT_SUCCESS);
    }
    else
    {
      perror("readline");
      exit(EXIT_SUCCESS);
    }
  }

  return cmd;
}
```

## è§£æå‘½ä»¤

åœ¨è·å–åˆ°è¾“å…¥çš„å‘½ä»¤åï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œè§£æï¼Œè¯†åˆ«å‡ºå‘½ä»¤å’Œå‚æ•°ã€‚

è¿™é‡Œä½¿ç”¨ `strtok` æ¥è¿›è¡Œåˆ†å‰²ï¼Œå°†åˆ†å‰²ä¹‹åçš„æ•°æ®æ”¾å…¥æ•°ç»„ä¸­ï¼Œæ•°ç»„ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œ`char *`ã€‚

ç”±äºè¾“å…¥çš„å­—ç¬¦ä¸²ä¸ªæ•°æ˜¯æœªçŸ¥çš„ï¼Œæ‰€ä»¥ä¸èƒ½äº‹å…ˆç»™æ•°ç»„ç¡®å®šåˆ†é…å¤šå°‘ç©ºé—´ã€‚å› æ­¤åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠåˆ°æ‰©å®¹çš„æ“ä½œã€‚

ç®€å•è¯´è¯´å¦‚ä½•æ‰©å®¹ã€‚

é¦–å…ˆï¼Œé»˜è®¤ç»™æ•°ç»„åˆ†é… N ä¸ªç©ºä½ã€‚åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¸æ–­å°†å­—ç¬¦ä¸²æ”¾å…¥æ•°ç»„ã€‚è‹¥æ•°ç»„é•¿åº¦è¶…è¿‡äº† Nï¼Œåˆ™è¿›è¡Œæ‰©å®¹ï¼Œæ¯æ¬¡ç©ºä½å¢åŠ  Nã€‚

æ¯”å¦‚ç¬¬ä¸€æ¬¡æ‰©å®¹åçš„ç©ºä½ä¸º 2 * Nï¼Œç¬¬äºŒæ¬¡æ‰©å®¹åçš„ç©ºä½ä¸º 3 * Nï¼Œä»¥æ­¤ç±»æ¨ã€‚

ä¸‹é¢çš„å®ç°ä¸­ï¼Œé»˜è®¤å®šä¹‰äº† 64 ä¸ªç©ºä½ã€‚

```objectivec
#define LSH_TOK_BUFSIZE 64
#define LSH_TOK_DELIM " \t\r\n\a"

// è§£æå‘½ä»¤
char **lsh_parse_cmd(char *cmd)
{
  int buffSize = LSH_TOK_BUFSIZE;
  int position = 0;

  char **tokens = malloc(buffSize * sizeof(char *));
  char *token;

  if (!tokens)
  {
    fprintf(stderr, "lsh: alloction error!\n");
    exit(EXIT_FAILURE);
  }

  // åˆ†éš”å­—ç¬¦ä¸²
  token = strtok(cmd, LSH_TOK_DELIM);
  while (token != NULL)
  {
    tokens[position++] = token;

		// æ‰©å®¹å¤„ç†
    if (position >= buffSize)
    {
      // realloc
      buffSize += LSH_TOK_BUFSIZE;
      tokens = realloc(tokens, buffSize * sizeof(char *));

      if (!tokens)
      {
        fprintf(stderr, "lsh: alloction error!\n");
        exit(EXIT_FAILURE);
      }
    }

    token = strtok(NULL, LSH_TOK_DELIM);
  }

  // ç»“å°¾ç©ºå­—ç¬¦
  tokens[position] = NULL;

  return tokens;
}
```

## æ‰§è¡Œå‘½ä»¤

å½“è§£æå‡ºå‘½ä»¤åï¼Œå°±éœ€è¦æ‰§è¡Œå‘½ä»¤ï¼Œè¿›è¡Œç›¸åº”æ“ä½œã€‚

è¿™é‡Œå¯ç”¨ä¸€ä¸ªå­è¿›ç¨‹æ¥è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨ `fork` åˆ›å»ºå­è¿›ç¨‹ã€‚

ç”±äº `fork` å‡ºæ¥çš„å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹æ˜¯æ‰§è¡ŒåŒæ ·çš„ä»£ç ï¼Œè€Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œè§£æå‡ºæ¥çš„å‘½ä»¤ï¼Œå› æ­¤ä½¿ç”¨ `execvp` æ¥æ›¿æ¢æ‰å­è¿›ç¨‹çš„ç¨‹åºã€‚

> `execvp` æ˜¯ `exec` çš„å˜ä½“ï¼Œp è¡¨ç¤ºå‘½ä»¤ä¸éœ€è¦å®Œæ•´è·¯å¾„ï¼Œv è¡¨ç¤ºå‚æ•°ä»¥æ•°ç»„æ–¹å¼ä¼ å…¥ã€‚

æœ€åï¼Œçˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹å®Œæˆã€‚

```objectivec
// å¯åŠ¨å­è¿›ç¨‹ï¼Œæ‰§è¡Œå‘½ä»¤
int lsh_launch(char **args)
{
  pid_t pid, wpid;
  int status;

  pid = fork();
  if (pid == 0)
  {
    // child
    if (execvp(args[0], args) < 0)
    {
      perror("lsh exec cmd error!");
    }

    exit(EXIT_FAILURE);
  }
  else if (pid < 0)
  {
    perror("lsh fork error!");
  }
  else
  {
		// ç­‰å¾…å­è¿›ç¨‹
    wpid = waitpid(pid, &status, WUNTRACED);
  }

  return 1;
}
```

## å†…ç½®å‘½ä»¤

è™½ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `execvp` æ¥æ‰§è¡Œæ–°çš„ç¨‹åºï¼Œä½†æ˜¯æœ‰äº›å‘½ä»¤è¿˜æ˜¯ä¸èƒ½åœ¨å­è¿›ç¨‹ä¸­å®ç°ã€‚

- æ¯”å¦‚ cdï¼Œç”¨äºåˆ‡æ¢ç›®å½•ã€‚ç›®å½•æ˜¯è·Ÿè¿›ç¨‹ç›¸å…³è”çš„ï¼Œå‡è‹¥åœ¨å­è¿›ç¨‹ä¸­åˆ‡æ¢ï¼Œé‚£ä¹ˆå®ƒåªæ˜¯å°†å­è¿›ç¨‹çš„ç›®å½•è¿›è¡Œäº†æ›´æ”¹ï¼Œä½†çˆ¶è¿›ç¨‹ä»æœªå—åˆ°å½±å“ã€‚
- ç±»ä¼¼çš„è¿˜æœ‰ exitï¼Œé€€å‡ºç¨‹åºã€‚åœ¨å­è¿›ç¨‹ä¸­å®ç°çš„è¯ï¼Œä¹Ÿä»…ä»…æ˜¯å­è¿›ç¨‹è‡ªèº«çš„é€€å‡ºã€‚

æ‰€ä»¥ï¼Œè¿˜éœ€è¦é¢å¤–å¤„ç†ä¸€äº›å‘½ä»¤ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå†…ç½®å‘½ä»¤ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬æ·»åŠ ä¸‰ä¸ªå†…ç½®å‘½ä»¤ï¼Œcdã€exitã€helpã€‚

- cdï¼Œç”¨äºåˆ‡æ¢ç›®å½•
- exitï¼Œé€€å‡ºç¨‹åº
- helpï¼Œæ‰“å°å†…ç½®å‘½ä»¤ä¿¡æ¯

### å†…ç½®å‘½ä»¤å£°æ˜

å†…ç½®å‘½ä»¤å­—ç¬¦ä¸²å®šä¹‰å¦‚ä¸‹ï¼š

```objectivec
char *builtin_str[] = {
    "cd",
    "help",
    "exit"
};
```

å†…ç½®å‘½ä»¤å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š

```objectivec
int (*builtin_func[])(char **) = {
    &lsh_cd,
    &lsh_help,
    &lsh_exit
};
```

å†…ç½®å‘½ä»¤ä¸ªæ•°è®¡ç®—ï¼š

```objectivec
int lsh_num_builtions()
{
  return sizeof(builtin_str) / sizeof(char *);
}
```

### cd

cd çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨ `chdir` å°±å¥½ï¼Œä¸‹é¢çš„ä»£ç ä¸­å¤§éƒ¨åˆ†æ˜¯é”™è¯¯å¤„ç†ã€‚

è¿™é‡Œçš„ `args[0]` æ˜¯ `"cd"`ï¼Œ`args[1]` æ˜¯è·¯å¾„å‚æ•°ã€‚

```objectivec
int lsh_cd(char **args)
{
  if (args == NULL)
  {
    perror("cd args error!");
  }

  if (args[1] == NULL)
  {
    fprintf(stderr, "lsh: no args\n");
  }
  else
  {
    if (chdir(args[1]) != 0)
    {
      perror("chdir error!");
    }
  }
  return 1;
}
```

### exit

é€€å‡ºç¨‹åºï¼Œåªéœ€åœ¨å‡½æ•°å®ç°ä¸­è¿”å› 0 å³å¯ã€‚æ­¤æ—¶å¾ªç¯ä¼šä¸­æ–­ï¼Œç„¶åç¨‹åºè‡ªç„¶é€€å‡ºã€‚

```objectivec
int lsh_exit(char **args)
{
  return 0;
}
```

### help

æ‰“å°å†…ç½®å‘½ä»¤ä¿¡æ¯ã€‚

```objectivec
int lsh_help(char **args)
{
  printf("lsh builtin cmd:\n");

  for (int i = 0; i < lsh_num_builtions(); i++)
  {
    printf("  %s\n", builtin_str[i]);
  }

  return 1;
}
```

### é¢å¤–å¤„ç†

æ·»åŠ å†…ç½®å‘½ä»¤åï¼Œåœ¨æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œå°±é¦–å…ˆéœ€è¦åˆ¤æ–­ä¸€ä¸‹å‘½ä»¤æ˜¯å¦æ˜¯å†…ç½®çš„ã€‚è‹¥æ˜¯ï¼Œåˆ™ä¼˜å…ˆèµ°å†…ç½®å®ç°ï¼›å¦åˆ™ï¼Œä½¿ç”¨å¯åŠ¨å­è¿›ç¨‹çš„æ–¹å¼å¤„ç†ã€‚

æœ€åï¼Œæ‰§è¡Œå‘½ä»¤çš„æµç¨‹å˜ä¸ºï¼š

```objectivec
// æ‰§è¡Œå‘½ä»¤
int lsh_execute_cmd(char **args)
{
  if (args == NULL || args[0] == NULL)
  {
    return -1;
  }

  char *cmd = args[0];

	// åˆ¤æ–­æ˜¯å¦æ˜¯å†…ç½®å‘½ä»¤
  for (int i = 0; i < lsh_num_builtions(); i++)
  {
    char *builtin_cmd = builtin_str[i];
    if (strcmp(cmd, builtin_cmd) == 0)
    {
			// æ‰§è¡Œè‡ªå®šä¹‰çš„å‡½æ•°
      return (*builtin_func[i])(args);
    }
  }

	// å¯åŠ¨å­è¿›ç¨‹
  return lsh_launch(args);
}
```

å°±è¿™æ ·ï¼Œä¸€ä¸ªç®€å•çš„ shell å°±å®Œæˆäº†ã€‚

## æ€»ç»“

è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº† shell æ˜¯ä»€ä¹ˆï¼Œä»¥åŠå¦‚ä½•åŠ¨æ‰‹å®ç° shell çš„ä¸»ä½“åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç­‰å¾…è¾“å…¥å‘½ä»¤ã€è§£æå‘½ä»¤ã€æ‰§è¡Œå‘½ä»¤ã€å†…ç½®å‘½ä»¤ç­‰ã€‚

æ•´ä½“å®ç°èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ğŸ¤©~

## å‚è€ƒèµ„æ–™

- [https://brennan.io/2015/01/16/write-a-shell-in-c/](https://brennan.io/2015/01/16/write-a-shell-in-c/)

